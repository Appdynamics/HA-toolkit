
 Copyright 2016 AppDynamics, Inc

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

--------------------------------------------

Release notes for version 3.0

In addition to bug fixes, the package has been substantially enhanced and 
re-written for enhanced portability, security, performance and maintainability.

The following new functionality is present:

1) replicate optionally can use of non-encrypted rsync.  in environments where 
a VPN or a dedicated network exists between primary and secondary controllers, 
replication can be noticably faster.  this is enabled by using the -U option.

2) mysql replication can use SSL encryption.  a pair of signed certificates 
and keys is exchanged between the 2 mysql instances.  after this negotiation,
all communication for mysql replication is encrypted.

3) mysql replication compression is enabled by default

4) the secondary no longer places replicated traffic in it's bin-logs.  this
greatly decreases disk usage on the secondary

5) scripts and support files are added for NUMA segregation

6) the machine agent is can run as non-root, and automatically is configured
with additional monitors to surface custom mysql and disk metrics. also,
the machine agent is automatically detected if it is in the controller root
directory or it's parent.  we use the controller JVM, so there is no need
to install anything other than the Java-less zip file of the machine agent.

7) configuration of an external monitoring host is simplified

8) support for controller versions greater than 4.2.0, which removed the
plaintext password file for mysql root.  we have 2 distinct solutions to
this:  recreate the db/.rootpw file, or run the save_mysql_passwd.sh script
which obfuscates the password and save that, unscrambling it whenever it is
needed

9) more extensive logging of the replicate process

10) init script configuration is now done via sysconfig files installed in
/etc/sysconfig (for redhat) or /etc/default (for debian).

11) greater compatibility with systemd.  newer linux distributions have a
different implementation of boot time init script handling, which does not
support the clean execution of the service status verb.  this is deprecated
on these systems, and a new script,  HA/appdstatus.sh, is supplied to replace 
this functionality.

Significant bug fixes in this release:

1) files of size less than 1M are checksummed to prevent rsync missing them
if changes to the file did not cause it to grow

2) the database health check now recovers if one of the steps timed out.

3) failover can not longer oscillate between two machines

4) the secondary controller now waits until the relay logs have been executed
before starting the new appserver on failover.   although this can take quite
some time, it prevents database inconsistencies.

------------------------------------
Release notes for version 3.0.1

this is a minor bugfix and enhancement release.

1) added support for fairly ugly root mysql passwords.  whitespace characters
are not supported, but punctuation is ok, plus $*()...

2) failover is a bit smarter about breaking replication.   all things being
otherwise ok, if the old primary has been up at least 1 hour, we don't break
replication

3) in the case of a persistent replication break, if we KNOW that the database
is not damaged on each end, we can run replicate -E to restore the slave to
operation.

4) the machine agent is started with nodename set

5) install_init.sh changes ownership of the machine agent to RUNUSER

6) Documentation on machine agent startup additions

--------------------------------------
Release notes for version 3.1

this is a bugfix version

1) some customer systems had paths with spaces in them.  this broke the machine
agent directory detection.  this code was pulled into a library function.

2) the watchdog.sh did no logging due to a coding error

3) numa machines with numa.settings need to disable the transparent huge page
facility.   this is done in the appdcontroller-db script.

4) some older systems xmllint does not support the --xpath option.  this is
avoided by using the universally available, but uglier, --shell option.

5) a better message is emitted when no password is available

6) README.md, a source hygiene document, was added

--------------------------------------
Release notes for version 3.2

this is a bugfix version

1) backwards compatibility with 3.9 series controllers enhanced

2) a new operations mode, triggered by the presence of HA/SHUTDOWN_FAILOVER,
   will automatically and immediately trigger the secondary to take over
   without breaking replication.   this is intended for external orderly
   shutdown handling of the HA pair as might occur on the azure platform
   support for this is present in appdcontroller init script and a new option
   to the failover.sh script

3) install_init.sh had an error when detecting if the controller uses ports
   less than 1024

4) the failover.sh script waited forever if there was a database replication 
   failure

5) running scripts outside the HA subdirectory printed a spurious error message
   from lib/log.sh

6) replicate.sh now plugs in a tier name into the controller_info.xml for the
   machine agent.

7) mysqlclient.sh now starts up faster for interactive use. an additional 
   option has been added that makes it compatible to controller.sh login-db 
   if line-oriented output is desired.

8) the HA.shar file automatically creates the HA directory if needed, and cd's
   into the HA directory if it is not already there.  it should be unpacked as 
   before, but this behavior is backward compatible and prevents problems.

9) the init scripts were further rationalized with common code removal,
   fixing a problem with memory size complaints and adding automatic setting
   of limits

10) the logging functions had a bug where the existence of /dev/tty was used
    instead of running /usr/bin/tty to test if tty output was possible

--------------------------------------
Release notes for version 3.3

this version adds limited function HA for systems without root escalation
or service installation. this is triggered by the existence of HA/NOROOT.
this functionality is currently undocumented, and failover has had only 
limited testing.

1) a new file, appdservice-noroot.sh, subsumes all the function in the
   appdcontroller, appdcontroller-db and appdynamics-machine-agent init
   scripts.

2) replicate.sh now detects if a file NOROOT is in the HA subdirectory, and
   does not check for init script installation or escalation methods

3) lib/ha.sh modifies the service functions to use the appdservice-noroot.sh
   script instead of using the /sbin/appdservice or sudo code if HA/NOROOT
   exists

4) the mysql monitor installed in the machine agent now searches for a controller
   root directory in /opt/AppDynamics/Controller and /opt/appdynamics/controller
   if it cannot find a definition in an appdynamics-machine-agent.sysconfig files.
   this is a likely case if NOROOT is installed.

--------------------------------------
Release notes for version 3.4

1) the machine agent init script now kills child processes of the machine
   agent.  this avoids leaving orphan monitor scripts running.

2) added the ability to trace the execution of the init scripts by putting
   a file INITDEBUG into the HA directory.  it creates a log file of the
   form /tmp/service_name.out where service_name is one of appdcontroller,
   appdcontroller-db, or appdynamics-machine-agent.

3) a bug in the memory calculation printed a spurious error message.

4) the save_mysql_password script erroneously tried to chmod the obfuscated
   password file.

5) the machine agent disk monitor now works with both 12 and 14 field
   iostat -x output

6) some additional documentation is added listing the commands that are
   added to the sudoers resource.

7) the sysconfig files are now templates.  any custom modifications are
   preserved if a file exists of the form service.sysconfig

8) an informative message is printed when non-root user runs install-init.sh.

--------------------------------------
Release notes for version 3.5

1) the default log expiration time is changed from 8 days to 3 days.  the
   amount of disk space saved is significant, and the use case for keeping
   replication stopped for 8 days is questionable at the very least.

2) the chkconfig and update_rc_d functions are not needed in the sudoers
   file.  they are not invoked by the HA package as non-root.

3) numa-patch-controller.sh gets run automatically when replicate -f is run.

4) when the -m option is explicitly specified, it writes out the monitoring
   definition to the file MONITOR.  Thenceforth, if this file exists, it sets 
   the default monitoring information for the controller and machine agent.

5) the DBOPLIMIT, which controlls the dbopfail test in the watchdog, is
   set to disable the test by default.  it should be enabled for systems
   with SAN attached disk.

6) appdynamics-machine-agent.sh now works on older linuxes that don't support
   ps -h.

7) simplified logging by eliminating the seperate SQL_ERROR path.

--------------------------------------
Release notes for version 3.5.1

1) Catch case when newly compiled /sbin/appdservice does not overwrite incumbent
   by removing old version first.

--------------------------------------
Release notes for version 3.5.2

1) the pesky messages about /root/.forever when trying to stop the appdcontroller
   service is now gone.  it was a coding error.

--------------------------------------
Release notes for version 3.5.3

1) the dbopfail watchdog test is suspect.  it is disabled by default both
   in the watchdog.sh and watchdog.settings.template

--------------------------------------
Release notes for version 3.6

1) the reporting service and events services on the local box were not being
   properly started and stopped by the init script, especially if the script
   in bin/controller.sh was also being used to manage these services.

--------------------------------------
Release notes for version 3.7

1) the watchdog.settings.template has an extensive comment concerning the
   reasons for when the dbop test should be enabled, and disables the test
   by default

2) lib/log.sh now does the password masking using unbuffered sed.  this makes
   the output of replicate.sh in the log file more interactive.

3) a typo in appdynamics-machine-agent.sh rarely would cause the machine agent
   to not start.

4) the machine agent service status now is properly factored out of 
   appdcontroller.sh

5) pbrun is now probed for in /usr/local/bin and /usr/bin

6) if the events directory is renamed, the init script makes no attempt
   to start or stop the events service.

7) a typo prevented explicit huge pages from being allocated

8) numa status is reported by appdstatus.sh on numa machines

9) a syntax change in replicate.sh makes the log slightly less noisy

10) install-init.sh had a syntax error that prevented pbrun from being properly
    detected

11) replicate.sh had a bug that prevented running as root

12) the format for numa.settings.template allows better numa node handling
    by explicitly creating a list of numa nodes that can be interrogated
    in scripts.

13) install-init and replicate.sh now complain when there is ambiguity in 
    finding the correct machine agent.  specify -a to force a specific instance.

14) several minor messages were eliminated or corrected.

15) code to resolve absolute paths now use readlink -e

16) appdservice-noroot.sh was updated to reflect common usage of APPD_ROOT

--------------------------------------
Release notes for version 3.7.1

1) fixed small bug preventing replicate.sh from starting when controller run as root

2) added datetime to end of incremental replicate to simplify determining time taken

--------------------------------------
Release notes for version 3.8

1) refactor of setting the monitoring controller to better support upgrades and
   appdynamics version 4.3.   the code to was pulled out into a new program,
   setmonitor.sh, which is invoked by replicate.sh at final replicate time.

2) appdynamics 4.3 removes network access to the mysql root user.  replicate
   now connects to the mysql instance on the secondary via ssh.

3) the numa.settings template now has defaults to membind instead of preferred.

4) the machine agent init script now removes the log in /tmp before appending
   to it when HA/INITDEBUG exists.

5) if a installation must activate a custom proxy or some other action after
   failover, creating an executable file named failover_hook.sh in the HA
   directory will cause that file to be run after each failover on the new
   primary.

--------------------------------------
Release notes for version 3.9

1) added a bit more flesh to the NOROOT option: INITDEBUG works, sysconfig
   files are read.

2) replace xmllint with xmlstarlet throughout.  much more flexible, as it
   abstracts out both edit and extract of xml documents.

3) cleaner implementation in lib/sql.sh to support controller 4.3; the
   remote sql connection is no longer supported.  now we use ssh.

4) fixes to the abstraction for setmonitor.sh and replicate.

5) watchdog.sh now does a mysql ping using ssh for 4.3.

6) watchdog.sh is more verbose when getting curl errors
   also, connection resets are treated as down.

--------------------------------------
Release notes for version 3.10

1) a tremendous amount of code movement to lib from places where there was duplication.
   essentially, anywhere where a function was defined twice or a variable was defined
   was pulled out into a single place.   this will make maintenance easier.  this is
   mostly visible in the creation of lib/status.sh

2) some variable name rationalization has been carried out.  pidfiles are suffixed _PIDFILE
   consistently, etc.

3) appdservice-noroot.sh had a serious bug in version 3.9 that prevented it from reading 
   the sysconfig files.

4) the package now uses lib/conf.sh to perform almost all config file editing.

5) setmonitor.sh had a real problem with arguments (app_name, etc) that contained spaces 
   or equal signs.

6) we now require the installation of xmlstarlet.

7) the generated application name had a spurious trailing colon.

8) HA now works with the secure credential store in 4.3.

--------------------------------------
Release notes for version 3.11

1) the assassin pid file was not being handled correctly due to a name
   confusion.  to prevent this, pidfiles are now named consistently

2) the controller_info_unset function was missing.

3) support for parallel replication using mysql 5.7
   this is enabled with the -7 option.  a future version will automatically
   detect mysql 5.7.

4) support for mysql 5.7's password obfuscator, which uses mysql_config_editor.

--------------------------------------
Release notes for version 3.12

1) pervasively added setting of PATH to ever user-invoked script to prevent
   running the wrong utility.   a number of sites had customer installations
   of variant, non-linux utilites that broke the HA package.

2) http_proxy environment variables can badly break the watchdog.  we suppress
   this functionality for curl.

3) the watchdog was not started by appdservice-noroot.sh.

4) install-init.sh now produces a log file.

5) the numa.settings.template now has the '=' character in the numactl syntax.

6) a subtle timing bug caused the watchdog to not always start: the parent
   ssh dying before the child could run nohup sends a sighup, which killed
   the watchdog.  this race is inherent in the way ssh and nohup work.

7) duplicate assassins and watchdogs were possible.  this is now prevented.

--------------------------------------
Release notes for version 3.13

1) removed dependency on xmlstarlet, as it has incompatible versions in the
   field and cannot be relied on to work.

--------------------------------------
Release notes for version 3.14 (pi)

1) install-init.sh now fails if HA/NOROOT exists.

2) a bug in appdservice-noroot.sh prevented it from running

3) the INITDEBUG option now creates log files owned by runuser.

4) the replication slave user now has least privilege.

5) the wildcard option in replicate.sh now works again.

--------------------------------------
Release notes for version 3.14.1 (more pi)

1) wildcard really working now.

--------------------------------------
Release notes for version 3.15

1) complete disable of dbop test in watchdog.sh


--------------------------------------
Release notes for version 3.16

1) a number of hard to diagnose HA failures were traced to a setting in the
   db.cnf.  sync_binlog=1 prevents the replication log and the innodb logs
   from being seen as inconsistent should the database crash.

2) the slave_pending_jobs_size_max setting needs to be there to allow the
   replication slave to run in parallel.

3) machine agent status is now reported by the controller init script

4) added options supporting mysql 5.7 parallel replication.

5) setmonitor.sh had an error if there was no crededential password

6) quoting problems arose in lib/conf.sh under certain conditions
   this required a modification in the fundamental runuser functions
   in lib/init.sh and lib/runuser.sh.

--------------------------------------
Release notes for version 3.17

1) more fragility with quoting has been eliminated.

2) the database logs are now saved and recreated whenever replicate is
   finalized.  this means that database logs will not be cluttered with
   historical information.

3) gtid mode is now enabled for the 5.7 databases.

4) setmonitor.sh now allows setting tier name

--------------------------------------
Release notes for version 3.18

1) lib/conf.sh did not correctly delete properties in controller_info.xml;
   this caused the emission of mailformed xml files, and the controllers
   were not monitored properly. this was introduced in 3.14

2) replicate now sets the default path for the mysql socket into the
   data directory.  this fixes a problem with controllers that do not
   start sometimes.

3) setmonitor.sh did not set the primary node name.  if the original
   controller-info.xml did not have a node-name in it, the secondary
   appserver would not be monitored on failover.

--------------------------------------
Release notes for version 3.19

1) the appdcontroller-db.sh init script did not properly start the
   database sometimes due to a hanging ex script.

2) watchdog.sh did not include the lib/status.sh script, so an alias failed.

--------------------------------------
Release notes for version 3.20

1) added watchdog.pid to the replicate excludes.   this prevents a rare
   startup problem
2) fixed a longstanding bug in the watchdog that caused spurious failovers.
3) adjusted the disk_stat.sh monitor to report KB/sec and greatly increased
   the reporting frequency.   this makes the min and max settings useful at
   a much higher measurement overhead,  this still will use less than a tenth
   of a core.
4) added prototype code for hot-sync replicate.  not currently recommended
   or supported.  needs percona xtrabackup and perl-DBD-mysql

--------------------------------------
Release notes for version 3.21

1) Added check within replicate.sh and failover.sh for broken 2-way passwordless 
   ssh between the two HA servers. This helps avoid complex failure cases 
   introduced by server ssh administration changes.

--------------------------------------
Release notes for version 3.22

1) added APPD_UPGRADE to document upgrading the controllers in an HA pair


--------------------------------------
Release notes for version 3.23

1) the APPD_UPGRADE document was greatly expanded
2) a rare replication bug is now prevented by validating .frm and .par files
3) bg_runuser sometimes did not reliably start the watchdog

--------------------------------------
Release notes for version 3.24

1) the ssh validation is broken.  It is bypassed until fixed.

--------------------------------------
Release notes for version 3.25

1) the java installation is not in the controller tree if the platform admin
   app was used to deploy the installation.   intelligence now locates the
   java accordingly. in addition, the database error log was moved.

2) the failover.sh formerly logged the start of the secondary service in
   a confusing manner when starting the watchdog.   this is now quiet, to
   the failover.log only.

3) connected with the fixes for java platform admin. the controller is located
   with a more general regexp in pgrep that will match all controllers.

4) the MONITOR files is copied to the secondary by the setmonitor.sh script

5) NOROOT is removed by a successful run of install-init.sh

6) we now announce the HA version when unpacking the shar file

7) the watchdog.settings file is now being read for overrides of the
   default settings.

8) a long standing syntax error in the pbrun wrapper has been fixed.

KNOWN BUGS:
9) the automatic propagation of the monitoring to the machine agent 
   is not reliable.  do this manually.

--------------------------------------
Release notes for version 3.26

1) the #!/bin/bash was inadvertently removed from replicate.sh

2) a coding error caused replicate.sh to fail when log files do not exist 
   on the secondary.

3) some minor doc fixes

--------------------------------------
Release notes for version 3.27

1) Fixed assorted logging issues to more reliably get messages when things go wrong.

2) Prevent occasional ssh hangs between nodes when new hostnames are used. All
   names and aliases within /etc/hosts are added to ~/.ssh/known_hosts and kept 
   up to date.

3) Prevent occasional MySQL replication failure due to permissions failure when
   new hostnames or aliases are added to /etc/hosts. All aliases for current
   hostname are permitted to connect to MySQL on the other host for replication only.

4) Fixed bug in controller-info.xml update.

5) Automatic backup of all HA Toolkit modified files to same directory 
   with extension ".$(date +%s)".

6) Added option to mysqlclient.sh "-r" to allow the raw pass-through of MySQL client
   command line options - helpful for raw/silent output with mysqlclient.sh -r -s.

7) Fixed bug in Glassfish Java agent monitor config when no -m (monitor) args
   supplied. 

8) Warn at Glassfish startup and shutdown if being run by userid that is not
   the same as expected by MySQL. This helps to fix issues when root is accidentally
   used to start or stop Glassfish which then prevents successful startup by
   subsequent non-root userid. Instructions are provided on how to fix the issue
   if it is detected.

--------------------------------------
Release notes for version 3.27.1

1) catch out of date awk that silently ignores character classes (usually Debian issue)

2) allow spaces within MySQL root password

3) fix bug in "service appdynamics-machine-agent stop" that sometimes killed a running ./replicate.sh
